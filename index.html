<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0f172a">
<title>å…ƒå™¨ä»¶ä»“åº“ v8.0</title>
<style>
    /* --- 1. æ ¸å¿ƒè§†è§‰é£æ ¼ --- */
    :root { 
        --bg-body: #0f172a; 
        --bg-card: #1e293b; 
        --bg-input: #334155;
        --bg-nav: rgba(15, 23, 42, 0.95);
        --text-main: #f8fafc; 
        --text-sub: #94a3b8;
        --accent: #38bdf8;
        --danger: #ef4444; 
        --success: #10b981; 
        --warning: #f59e0b;
        --pick: #f472b6; /* é¢†æ–™æ¨¡å¼ä¸»è‰² */
        --tag-bg: rgba(139, 92, 246, 0.2); /* æ ‡ç­¾èƒŒæ™¯è‰² */
        --tag-text: #a78bfa;
        --border: 1px solid rgba(255, 255, 255, 0.1); 
        --radius: 12px;
        --nav-height: 60px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
    
    html, body { 
        height: 100%; width: 100%; overflow: hidden; 
        background: var(--bg-body); 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        color: var(--text-main); 
        overscroll-behavior: none; position: fixed; left: 0; top: 0;
    }

    /* --- 2. å¸ƒå±€æ¡†æ¶ --- */
    .app { 
        position: fixed; inset: 0; display: flex; flex-direction: column; 
        height: 100%; max-width: 600px; margin: 0 auto; z-index: 1; background: var(--bg-body);
    }
    
    /* é¡¶éƒ¨å¯¼èˆª */
    .navbar { 
        flex-shrink: 0; height: 60px; padding: 0 16px; background: var(--bg-nav); backdrop-filter: blur(10px);
        border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 20;
    }
    .brand { font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 8px; letter-spacing: 0.5px; cursor: pointer; }
    .nav-btns { display: flex; gap: 8px; }
    
    .btn-icon { 
        width: 36px; height: 36px; border-radius: 8px; border: var(--border); 
        background: rgba(255,255,255,0.05); color: var(--text-main); 
        display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        position: relative;
    }
    .btn-icon:active { background: var(--accent); color: #000; border-color: var(--accent); }
    .btn-icon.active-mode { background: var(--pick); color: white; border-color: var(--pick); }

    .btn-primary { 
        background: var(--accent); color: #0f172a; font-weight: bold; padding: 0 16px; height: 36px; 
        border-radius: 8px; border: none; display: flex; align-items: center; gap: 6px; cursor: pointer;
    }
    .btn-primary:active { opacity: 0.9; transform: scale(0.96); }

    /* å†…å®¹è§†å£ */
    .viewport { 
        flex: 1; overflow-y: auto; overflow-x: hidden; padding: 16px; padding-bottom: 90px;
        scroll-behavior: smooth; position: relative; overscroll-behavior-y: contain; -webkit-overflow-scrolling: touch;
    }
    
    .view-page { display: none; animation: fadeIn 0.3s ease; }
    .view-page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- 3. é¡µé¢å…ƒç´  --- */
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .stat-card { 
        background: var(--bg-card); border: var(--border); border-radius: var(--radius); padding: 12px 16px; 
        display: flex; flex-direction: column; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
    }
    .stat-card:active { transform: scale(0.98); background: #283648; }
    .stat-card.active-filter { border-color: var(--accent); background: rgba(56, 189, 248, 0.1); }
    .stat-card.alert.active-filter { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }

    .stat-label { font-size: 11px; color: var(--text-sub); font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
    .stat-num { font-size: 24px; font-weight: 800; color: var(--text-main); }
    .stat-card.alert .stat-num { color: var(--danger); }

    /* æœç´¢ä¸ç­›é€‰ */
    .search-row { 
        display: flex; gap: 8px; position: sticky; top: 0; z-index: 10; 
        background: var(--bg-body); padding: 10px 0; margin: 0 0 10px 0;
    }
    .search-wrap { position: relative; flex: 1; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); pointer-events: none; }
    .search-input { 
        width: 100%; height: 44px; background: var(--bg-input); border: var(--border); border-radius: 10px; 
        padding: 0 36px; color: white; font-size: 16px; transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--accent); }
    .clear-btn { 
        position: absolute; right: 0; top: 0; bottom: 0; width: 40px; display: flex; align-items: center; justify-content: center; 
        color: var(--text-sub); cursor: pointer; display: none;
    }
    
    .icon-btn-square {
        width: 44px; height: 44px; background: var(--bg-input); border: var(--border); border-radius: 10px;
        display: flex; align-items: center; justify-content: center; color: var(--text-sub); cursor: pointer;
        flex-shrink: 0;
    }
    .icon-btn-square.active { color: var(--accent); border-color: var(--accent); }
    .filter-select { 
        height: 44px; background: var(--bg-input); border: var(--border); border-radius: 10px; 
        color: white; padding: 0 12px; font-size: 14px; outline: none; max-width: 100px;
    }

    /* åˆ—è¡¨å¡ç‰‡ */
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media(min-width: 500px) { .grid { grid-template-columns: 1fr 1fr; } }

    .card { 
        background: var(--bg-card); border: var(--border); border-radius: var(--radius); padding: 16px; 
        position: relative; transition: transform 0.1s, background-color 0.2s;
        user-select: none; -webkit-user-select: none; touch-action: pan-y; overflow: hidden; cursor: pointer;
    }
    .card.pressing { transform: scale(0.96); background: #283648; border-color: var(--accent); }
    .card.selected { background: rgba(56, 189, 248, 0.15); border-color: var(--accent); }
    
    /* é¢†æ–™æ¨¡å¼æ ·å¼ */
    .app.picking-mode .navbar { border-bottom-color: var(--pick); }
    .app.picking-mode .card.picked { border-color: var(--pick); background: rgba(244, 114, 182, 0.1); }
    .app.picking-mode .btn-primary { background: #334155; color: #94a3b8; } /* ç¦ç”¨æ·»åŠ æŒ‰é’®åœ¨é¢†æ–™æ¨¡å¼ */

    .check-mark { 
        position: absolute; top: 10px; right: 10px; width: 22px; height: 22px; border-radius: 50%; 
        background: var(--accent); color: #000; display: none; align-items: center; justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 5;
    }
    .card.selected .check-mark { display: flex; animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes pop { from {transform: scale(0);} to {transform: scale(1);} }

    .card-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .tag-row { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .tag { font-size: 10px; background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 4px; color: var(--text-sub); }
    .recent-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; display: none; box-shadow: 0 0 5px var(--success); }
    
    .loc { font-family: monospace; font-size: 12px; color: var(--accent); font-weight: bold; padding: 2px 6px; border-radius: 4px; transition: background 0.2s; }
    .loc:active { background: rgba(56,189,248,0.2); }
    .highlight { background: rgba(255, 255, 0, 0.3); color: #fff; border-radius: 2px; }
    
    /* æ™ºèƒ½æ ‡ç­¾æ ·å¼ */
    .tag-pill {
        display: inline-block; font-size: 10px; color: var(--tag-text); background: var(--tag-bg);
        padding: 1px 6px; border-radius: 10px; margin-right: 4px; cursor: pointer; font-weight: bold;
    }
    .tag-pill:active { opacity: 0.7; }

    .card-title { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 4px; line-height: 1.3; padding-right: 20px; word-break: break-all; }
    .pkg { display: inline-block; font-size: 11px; color: var(--text-sub); background: rgba(0,0,0,0.2); padding: 1px 5px; border-radius: 4px; margin-bottom: 8px; }
    
    .link-icon {
        position: absolute; top: 12px; right: 12px; color: var(--text-sub); opacity: 0.6;
        padding: 4px; z-index: 2; transition: 0.2s;
    }
    .link-icon:active { color: var(--accent); opacity: 1; transform: scale(1.1); }
    .card.selected .link-icon { display: none; }

    .stock-bg { height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin: 8px 0; overflow: hidden; }
    .stock-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
    .desc-text { font-size: 11px; color: #64748b; max-width: 55%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .qty-box { display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.2); border-radius: 6px; padding: 2px; }
    .qty-btn { width: 36px; height: 36px; border: none; background: transparent; color: var(--text-sub); font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; touch-action: manipulation; }
    .qty-btn:active { color: white; background: rgba(255,255,255,0.1); border-radius: 4px; }
    .qty-val { font-size: 14px; font-weight: bold; min-width: 24px; text-align: center; }
    
    /* é¢†æ–™æ¨¡å¼ä¸‹æ•°é‡é¢œè‰² */
    .app.picking-mode .qty-box { background: rgba(244, 114, 182, 0.2); }
    .app.picking-mode .qty-val.picked-val { color: var(--pick); }

    /* --- å›¾è¡¨ä¸å·¥å…· --- */
    .chart-container { position: relative; width: 220px; height: 220px; margin: 30px auto; }
    .chart-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
    .chart-segment { cursor: pointer; transition: opacity 0.2s; }
    .chart-segment:active { opacity: 0.7; }
    .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    .legend-item { display: flex; align-items: center; gap: 8px; background: var(--bg-card); padding: 8px 12px; border-radius: 8px; font-size: 12px; border: var(--border); color: var(--text-sub); cursor: pointer; }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

    .tool-section { background: var(--bg-card); border: var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; }
    .tool-title { font-weight: bold; font-size: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; color: var(--text-main); }
    
    .log-list { max-height: 200px; overflow-y: auto; font-size: 12px; }
    .log-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-sub); }
    .log-time { font-family: monospace; opacity: 0.7; font-size: 10px; margin-right: 8px; }

    .resistor-body { height: 50px; background: linear-gradient(to bottom, #fca5a5, #ef4444); border-radius: 25px; position: relative; display: flex; justify-content: space-evenly; align-items: center; margin: 20px 0; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.2); }
    .res-band { width: 10px; height: 50px; background: #000; cursor: pointer; box-shadow: 0 0 5px rgba(0,0,0,0.3); transition: transform 0.1s; }
    .res-band:active { transform: scale(1.2); }
    .color-grid { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-top: 10px; }
    .c-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); }

    /* --- åº•éƒ¨èœå• --- */
    .tab-bar {
        flex-shrink: 0; height: var(--nav-height); background: var(--bg-nav); backdrop-filter: blur(12px);
        border-top: var(--border); display: flex; justify-content: space-around; align-items: center;
        position: absolute; bottom: 0; left: 0; right: 0; z-index: 50; padding-bottom: env(safe-area-inset-bottom);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tab-btn { background: none; border: none; color: var(--text-sub); display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; padding: 8px; width: 100%; cursor: pointer; }
    .tab-btn.active { color: var(--accent); }
    .tab-btn svg { width: 22px; height: 22px; stroke-width: 2; }

    /* --- æ‰¹é‡æ  / é¢†æ–™æ  --- */
    .batch-bar {
        position: absolute; bottom: 0; left: 0; right: 0; background: #1e293b; border-top: 1px solid var(--accent);
        padding: 12px 16px; padding-bottom: max(12px, env(safe-area-inset-bottom));
        display: flex; justify-content: space-between; align-items: center;
        transform: translateY(100%); transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 60; box-shadow: 0 -4px 25px rgba(0,0,0,0.6);
    }
    .batch-bar.show { transform: translateY(0); }
    
    /* é¢†æ–™æ¨¡å¼ç‰¹å®šçš„ Bar */
    .batch-bar.picking { border-top-color: var(--pick); }
    .picking-info { color: var(--pick); font-size: 12px; font-weight: bold; }
    
    .batch-info { display: flex; flex-direction: column; }
    .batch-count { color: var(--accent); font-weight: 800; font-size: 16px; }
    .batch-label { color: var(--text-sub); font-size: 10px; }
    .batch-actions { display: flex; gap: 8px; }
    .b-btn { padding: 0 14px; height: 38px; border-radius: 8px; font-size: 13px; font-weight: bold; cursor: pointer; border: none; display: flex; align-items: center; gap: 4px; }
    .b-btn-outline { background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid rgba(255,255,255,0.1); }
    .b-btn-danger { background: rgba(239,68,68,0.2); color: #fca5a5; }
    .b-btn-pick { background: var(--pick); color: #000; }

    /* --- å¼¹çª— --- */
    /* Z-Index 100 ç”¨äºç¼–è¾‘å¼¹çª— */
    .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 100; display: none; justify-content: center; align-items: center; overscroll-behavior: contain; }
    .modal-mask.open { display: flex; }
    .modal-box { width: 90%; max-width: 340px; background: #1e293b; border: var(--border); border-radius: 16px; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); animation: scaleIn 0.2s; max-height: 85vh; overflow-y: auto; }
    @keyframes scaleIn { from {transform: scale(0.95); opacity: 0;} to {transform: scale(1); opacity: 1;} }
    
    .form-group { margin-bottom: 14px; }
    .form-label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 6px; }
    .form-input { 
        width: 100%; background: #334155; border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; color: white; 
        font-size: 16px; 
    }
    .form-input:focus { border-color: var(--accent); }
    
    .sheet-modal { align-items: flex-end; }
    .sheet-box { 
        width: 100%; max-width: 600px; background: #1e293b; border-top: var(--border); 
        border-radius: 20px 20px 0 0; padding: 24px; padding-bottom: max(24px, env(safe-area-inset-bottom));
        transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
    }
    .modal-mask.open .sheet-box { transform: translateY(0); }
    .action-btn { 
        width: 100%; padding: 16px; margin-bottom: 10px; background: rgba(255,255,255,0.03); 
        border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 16px; cursor: pointer;
    }
    .action-btn:active { background: rgba(255,255,255,0.08); }
    
    /* ç¡®è®¤å¼¹çª— Z-Index 200ï¼Œç¡®ä¿åœ¨ç¼–è¾‘å¼¹çª—ä¹‹ä¸Š */
    #confirm-modal { z-index: 200 !important; }

    /* Toast */
    .toast { 
        position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px); 
        background: #fff; color: #000; padding: 8px 20px; border-radius: 30px; 
        font-size: 13px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 300; font-weight: bold; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 12px; white-space: nowrap;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
    .toast-btn { color: var(--accent); font-weight: 800; cursor: pointer; padding: 4px; }
    
    /* é¢†æ–™å¾½æ ‡ */
    .pick-badge {
        position: absolute; top: -5px; right: -5px; width: 18px; height: 18px;
        background: var(--pick); color: white; border-radius: 50%; font-size: 10px;
        display: flex; align-items: center; justify-content: center; font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
</style>
</head>
<body>

<div class="app" id="app-container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar">
        <div class="brand" onclick="window.scrollTo({top:0,behavior:'smooth'})">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            å…ƒå™¨ä»¶ä»“åº“ <span style="font-size:10px; opacity:0.5; margin-left:4px;">v7.9</span>
        </div>
        <div class="nav-btns">
            <!-- é¢†æ–™/é…å•æ¨¡å¼æŒ‰é’® -->
            <div class="btn-icon" id="btn-pick-mode" onclick="togglePickingMode()" title="é¢†æ–™/é…å•æ¨¡å¼">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                <div id="pick-badge-main" class="pick-badge" style="display:none">0</div>
            </div>
            <div class="btn-icon" onclick="triggerImport()" title="å¯¼å…¥ (JSON/BOM CSV)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></div>
            <div class="btn-icon" onclick="openExport()" title="å¯¼å‡º"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></div>
            <button class="btn-primary" id="btn-add-main" onclick="openModal()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> æ·»åŠ </button>
        </div>
    </nav>

    <div class="viewport">
        <!-- é¡µé¢ 1: ä»“åº“ -->
        <div id="view-home" class="view-page active">
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div class="stats-panel">
                <div class="stat-card" id="card-total" onclick="quickFilter('All')">
                    <div class="stat-label">æ€»åº“å­˜ç§ç±»</div>
                    <div class="stat-num" id="st-total">0</div>
                </div>
                <div class="stat-card alert" id="card-low" onclick="quickFilter('Low')">
                    <div class="stat-label">âš ï¸ ç¼ºè´§ (<5)</div>
                    <div class="stat-num" id="st-low" style="color: var(--danger);">0</div>
                </div>
            </div>

            <!-- æœç´¢æ  -->
            <div class="search-row">
                <div class="search-wrap">
                    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="search-inp" class="search-input" placeholder="æœç´¢... (#æ ‡ç­¾ ç©ºæ ¼åˆ†éš”)" oninput="render()" autocomplete="off">
                    <div id="search-clear" class="clear-btn" onclick="clearSearch()" style="display: none;">âœ•</div>
                </div>
                <div class="icon-btn-square" id="sort-btn" onclick="toggleSort()" title="æ’åº">
                    <svg id="sort-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                </div>
                <select id="filter-sel" class="filter-select" onchange="render()">
                    <option value="All">å…¨éƒ¨</option>
                    <option value="MCU">ä¸»æ§</option>
                    <option value="Sensor">ä¼ æ„Ÿå™¨</option>
                    <option value="Passive">é˜»å®¹æ„Ÿ</option>
                    <option value="Module">æ¨¡å—</option>
                    <option value="Conn">è¿æ¥å™¨</option>
                    <option value="Power">ç”µæº</option>
                    <option value="Other">å…¶ä»–</option>
                </select>
            </div>

            <div id="grid" class="grid"></div>
            <div id="empty-state" style="text-align:center; color:var(--text-sub); padding:60px 0; display:none;">
                <div style="font-size:48px; margin-bottom:16px; opacity:0.5;">ğŸ“¦</div>
                <div style="font-size:16px; font-weight:bold; margin-bottom:8px;">æœªæ‰¾åˆ°åŒ¹é…å…ƒä»¶</div>
                <div style="font-size:12px; opacity:0.6;">å°è¯•å‡å°‘å…³é”®å­—æˆ–æ£€æŸ¥æ‹¼å†™</div>
            </div>
        </div>

        <!-- é¡µé¢ 2: ç»Ÿè®¡ä¸æ—¥å¿— -->
        <div id="view-stats" class="view-page">
            <div class="tool-section">
                <div class="tool-title">åº“å­˜åˆ†å¸ƒ</div>
                <div class="chart-container">
                    <svg id="donut-chart" width="220" height="220" viewBox="0 0 100 100" style="transform: rotate(-90deg);"></svg>
                    <div class="chart-center">
                        <div style="font-size:28px; font-weight:800; color:var(--text-main)" id="chart-total">0</div>
                        <div style="font-size:10px; color:var(--text-sub)">ç§ç±»</div>
                    </div>
                </div>
                <div id="legend-container" class="legend-grid"></div>
            </div>
            
            <div class="tool-section">
                <div class="tool-title">
                    <span>ğŸ•’ æ“ä½œæ—¥å¿—</span>
                    <button onclick="clearLogs()" style="font-size:10px; padding:2px 8px; border:1px solid rgba(255,255,255,0.2); background:none; color:var(--text-sub); border-radius:4px;">æ¸…ç©º</button>
                </div>
                <div class="log-list" id="log-list">
                    <div style="padding:10px; text-align:center; opacity:0.5">æš‚æ— è®°å½•</div>
                </div>
            </div>
        </div>

        <!-- é¡µé¢ 3: å·¥å…· -->
        <div id="view-tools" class="view-page">
            <div class="tool-section">
                <div class="tool-title">ğŸ·ï¸ å°è£…å°ºå¯¸å‚è€ƒ</div>
                <div style="display:flex; align-items:center; gap:16px;">
                    <div id="pkg-visual" style="width:60px; height:60px; border:1px solid #fff; display:flex; align-items:center; justify-content:center; font-size:10px; color:var(--bg-body);">?</div>
                    <div style="flex:1">
                        <input class="form-input" id="pkg-inp" placeholder="è¾“å…¥ 0805, SOT23..." oninput="calcPkg()">
                        <div id="pkg-res" style="margin-top:8px; color:var(--accent); font-weight:bold; height:20px;"></div>
                    </div>
                </div>
            </div>

            <div class="tool-section">
                <div class="tool-title">
                    <span>ğŸŒˆ è‰²ç¯ç”µé˜»è®¡ç®—</span>
                    <button id="band-btn" onclick="toggleBands()" style="font-size:11px; background:rgba(255,255,255,0.1); border:none; color:white; padding:2px 8px; border-radius:4px;">4ç¯</button>
                </div>
                <div class="resistor-body" id="res-body"></div>
                <div style="text-align:center; font-size:24px; font-weight:bold; color:var(--accent); margin:10px 0;" id="res-val">1 kÎ©</div>
                <div class="color-grid" id="color-palette"></div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨èœå• -->
    <nav class="tab-bar" id="tab-bar">
        <button class="tab-btn active" onclick="switchTab('home', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            ä»“åº“
        </button>
        <button class="tab-btn" onclick="switchTab('stats', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
            ç»Ÿè®¡
        </button>
        <button class="tab-btn" onclick="switchTab('tools', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
            å·¥å…·
        </button>
    </nav>

    <!-- æ‰¹é‡æ“ä½œæ  / é¢†æ–™æ  -->
    <div id="batch-bar" class="batch-bar">
        <!-- é»˜è®¤æ‰¹é‡æ¨¡å¼å†…å®¹ -->
        <div id="batch-content-default" style="display:none; width:100%; justify-content:space-between; align-items:center;">
            <div class="batch-info">
                <span class="batch-count" id="sel-count">0</span>
                <span class="batch-label">å·²é€‰æ‹©</span>
            </div>
            <div class="batch-actions">
                <button onclick="toggleSelectAll()" class="b-btn b-btn-outline" id="btn-select-all">å…¨é€‰</button>
                <button onclick="openBatchEditModal()" class="b-btn b-btn-outline"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> ç¼–è¾‘</button>
                <button onclick="batchCopy()" class="b-btn b-btn-outline"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> å¤åˆ¶</button>
                <button onclick="batchDel()" class="b-btn b-btn-danger"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                <div onclick="exitSelection()" style="display:flex; align-items:center; justify-content:center; width:38px; height:38px; border-radius:50%; background:rgba(255,255,255,0.05); margin-left:8px; cursor:pointer;">âœ•</div>
            </div>
        </div>

        <!-- é¢†æ–™æ¨¡å¼å†…å®¹ -->
        <div id="batch-content-picking" style="display:none; width:100%; justify-content:space-between; align-items:center;">
            <div class="batch-info">
                <span class="batch-count" id="pick-total" style="color:var(--pick)">0</span>
                <span class="batch-label">å·²é¢†æ•°é‡ (ç§:<span id="pick-types">0</span>)</span>
            </div>
            <div class="batch-actions">
                <button onclick="finishPicking('deduct')" class="b-btn b-btn-pick" style="background:var(--pick); color:black;">ä¸€é”®å‡ºåº“</button>
                <button onclick="finishPicking('export')" class="b-btn b-btn-outline" style="border-color:var(--pick); color:var(--pick);">å¯¼å‡ºæ¸…å•</button>
                <div onclick="togglePickingMode()" style="display:flex; align-items:center; justify-content:center; width:38px; height:38px; border-radius:50%; background:rgba(255,255,255,0.05); margin-left:8px; cursor:pointer;">âœ•</div>
            </div>
        </div>
    </div>
</div>

<!-- ç¡®è®¤å¼¹çª— (æ›¿ä»£ confirm) -->
<div id="confirm-modal" class="modal-mask">
    <div class="modal-box" style="text-align:center; padding-top:30px;">
        <div style="font-size:40px; margin-bottom:10px;" id="confirm-icon">ğŸ¤”</div>
        <h3 id="confirm-msg" style="margin-bottom:8px;">ç¡®å®šè¦æ‰§è¡Œå—ï¼Ÿ</h3>
        <div id="confirm-sub" style="font-size:12px; color:var(--text-sub); margin-bottom:20px;"></div>
        <div style="display:flex; gap:12px;">
            <button onclick="closeConfirm()" style="flex:1; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:none; color:var(--text-sub); cursor:pointer;">å–æ¶ˆ</button>
            <button id="confirm-yes-btn" style="flex:1; padding:12px; border-radius:8px; border:none; background:var(--accent); color:#000; font-weight:bold; cursor:pointer;">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- æ‰¹é‡ç¼–è¾‘å¼¹çª— -->
<div id="batch-edit-modal" class="modal-mask">
    <div class="modal-box">
        <h3 style="margin-bottom:16px; font-weight:800; font-size:18px;">æ‰¹é‡ç¼–è¾‘ <span id="batch-edit-count" style="color:var(--accent)">0</span> é¡¹</h3>
        <div style="font-size:12px; color:var(--text-sub); margin-bottom:20px;">ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯¹åº”å­—æ®µ</div>
        
        <div class="form-group">
            <label class="form-label">ä¿®æ”¹å‚¨ä½</label>
            <input class="form-input" id="be-loc" placeholder="ä¾‹å¦‚: Box-01">
        </div>
        
        <div class="form-group">
            <label class="form-label">ä¿®æ”¹åˆ†ç±»</label>
            <select class="form-input" id="be-cat">
                <option value="">(ä¸ä¿®æ”¹)</option>
                <option value="MCU">ä¸»æ§èŠ¯ç‰‡</option><option value="Sensor">ä¼ æ„Ÿå™¨</option><option value="Passive">é˜»å®¹æ„Ÿ</option>
                <option value="Module">æ¨¡å—</option><option value="Conn">è¿æ¥å™¨</option><option value="Power">ç”µæº</option><option value="Other">å…¶ä»–</option>
            </select>
        </div>

        <div style="display:flex; gap:12px; margin-top:24px;">
            <button onclick="closeBatchEdit()" style="flex:1; background:none; border:1px solid rgba(255,255,255,0.1); color:var(--text-sub); border-radius:8px; height:40px; cursor:pointer;">å–æ¶ˆ</button>
            <button onclick="saveBatchEdit()" style="flex:1; background:var(--accent); color:#0f172a; border:none; border-radius:8px; height:40px; font-weight:bold; cursor:pointer;">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ·»åŠ /ç¼–è¾‘ -->
<div id="modal-mask" class="modal-mask">
    <div class="modal-box">
        <h3 style="margin-bottom:20px; font-weight:800; font-size:18px; display:flex; justify-content:space-between;">
            <span>ğŸ“ å…ƒä»¶ä¿¡æ¯</span>
            <span onclick="closeModal()" style="font-weight:400; font-size:24px; color:var(--text-sub); cursor:pointer;">Ã—</span>
        </h3>
        <input type="hidden" id="e-id">
        <div class="form-group"><label class="form-label">åç§° <span style="color:var(--danger)">*</span></label><input class="form-input" id="e-name" placeholder="å¦‚ ESP32-C3"></div>
        
        <div style="display:flex; gap:12px;">
            <div class="form-group" style="flex:1"><label class="form-label">å°è£…</label><input class="form-input" id="e-model" placeholder="SOP8"></div>
            <div class="form-group" style="flex:1"><label class="form-label">å‚¨ä½</label><input class="form-input" id="e-loc" placeholder="A-01"></div>
        </div>
        
        <div class="form-group"><label class="form-label">åˆ†ç±»</label>
            <select class="form-input" id="e-cat">
                <option value="MCU">ä¸»æ§èŠ¯ç‰‡</option><option value="Sensor">ä¼ æ„Ÿå™¨</option><option value="Passive">é˜»å®¹æ„Ÿ</option>
                <option value="Module">æ¨¡å—</option><option value="Conn">è¿æ¥å™¨</option><option value="Power">ç”µæº</option><option value="Other">å…¶ä»–</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">å‚è€ƒé“¾æ¥ (æ•°æ®æ‰‹å†Œ/è´­ä¹°)</label>
            <input class="form-input" id="e-link" placeholder="https://..." style="font-size:12px;">
        </div>

        <div class="form-group"><label class="form-label">æ•°é‡</label><input type="number" class="form-input" id="e-qty" value="1"></div>
        <div class="form-group"><label class="form-label">å¤‡æ³¨ (æ”¯æŒ #æ ‡ç­¾)</label><textarea class="form-input" id="e-desc" rows="2" placeholder="å‚æ•°ã€#é¡¹ç›®A ç­‰"></textarea></div>
        
        <div style="display:flex; gap:12px; margin-top:24px;">
            <button onclick="delItem()" id="btn-del" style="background:rgba(239,68,68,0.2); color:#fca5a5; border:none; border-radius:8px; padding:0 16px; display:none; font-weight:bold; cursor:pointer;">åˆ é™¤</button>
            <button onclick="saveItem()" style="background:var(--accent); color:#0f172a; border:none; border-radius:8px; height:44px; flex:1; font-weight:bold; cursor:pointer;">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="sheet-mask" class="modal-mask sheet-modal" onclick="closeExport()">
    <div class="sheet-box" onclick="event.stopPropagation()">
        <h3 style="margin-bottom:20px; font-weight:800; font-size:18px;">æ•°æ®æ“ä½œ</h3>
        <div class="action-btn" onclick="doExport('shopping')">
            <div>
                <div style="color:var(--warning); font-weight:bold;">ğŸ“‹ å¤åˆ¶ç¼ºè´§æ¸…å•</div>
                <div style="font-size:12px; color:var(--text-sub);">å¯¼å‡ºæ•°é‡å°‘äº 5 çš„é¡¹ç›®</div>
            </div>
        </div>
        <div class="action-btn" onclick="doExport('copy')">
            <div>
                <div style="color:var(--accent); font-weight:bold;">ğŸ“„ å¤åˆ¶æ•°æ® (å¤‡ä»½)</div>
                <div style="font-size:12px; color:var(--text-sub);">å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œæ‰‹åŠ¨ä¿å­˜</div>
            </div>
        </div>
        <div class="action-btn" onclick="doExport('download')">
            <div>
                <div style="color:var(--success); font-weight:bold;">ğŸ’¾ ä¸‹è½½å¤‡ä»½ (JSON)</div>
                <div style="font-size:12px; color:var(--text-sub);">ä¿å­˜ä¸ºæ–‡ä»¶</div>
            </div>
        </div>
        <div class="action-btn" onclick="doExport('app')">
            <div>
                <div style="color:#a78bfa; font-weight:bold;">ğŸ“± ç”Ÿæˆç‹¬ç«‹ APP</div>
                <div style="font-size:12px; color:var(--text-sub);">ä¿å­˜ä¸ºåŒ…å«æ•°æ®çš„ HTML</div>
            </div>
        </div>
        <div onclick="closeExport()" style="text-align:center; padding:16px; color:var(--text-sub); border-top:var(--border); margin-top:10px; cursor:pointer;">å–æ¶ˆ</div>
    </div>
</div>

<div id="toast" class="toast">
    <span id="toast-msg">æ“ä½œæˆåŠŸ</span>
    <div id="toast-undo" class="toast-btn" style="display:none" onclick="undoDelete()">æ’¤é”€</div>
</div>
<!-- ä¿®æ”¹ accept å±æ€§ä»¥æ”¯æŒ CSV -->
<input type="file" id="file-input" accept=".json,.csv" style="display:none" onchange="onFileRead(event)">

<script>
    // -------------------------------------------------------------------------
    // æ•°æ®å®šä¹‰åŒºåŸŸ (ä¸è¦åˆ é™¤ä»¥ä¸‹æ•°ç»„ç»“æ„)
    // -------------------------------------------------------------------------
    const PRELOAD = [
      {"id": 1, "name": "ESP32-WROOM", "model": "Module", "cat": "MCU", "qty": 5, "loc": "A-01", "desc": "WiFi+BT #é¡¹ç›®A", "link": ""},
      {"id": 2, "name": "10K Resistor", "model": "0603", "cat": "Passive", "qty": 200, "loc": "C-05", "desc": "1% #å¸¸ç”¨", "link": ""}
    ];
    // -------------------------------------------------------------------------
    
    // ä¿æŒ key ä¸€è‡´ï¼Œç¡®ä¿ç”¨æˆ·å‡çº§æ—¶æ•°æ®ä¸ä¸¢å¤±
    const KEY = 'components_v7_0_final';
    const LOG_KEY = 'components_logs_v7';
    
    let db = [];
    let logs = [];
    
    // çŠ¶æ€
    let selectMode = false;
    let pickingMode = false; // æ–°å¢ï¼šé¢†æ–™æ¨¡å¼
    let selected = new Set();
    let pickingMap = {}; // {id: qty} è®°å½•é¢†æ–™æ•°é‡
    
    let touchStart = {x:0, y:0};
    let longPressTimer = null;
    let isDrag = false;
    let hasLongPressed = false; 
    let sortMode = 'time'; 
    let activeFilter = 'All'; 
    let deletedBuffer = null; 

    // --- ç¡®è®¤å¼¹çª—é€»è¾‘ ---
    let confirmCallback = null;
    function showConfirm(msg, subMsg, type, cb) {
        document.getElementById('confirm-msg').innerText = msg;
        document.getElementById('confirm-sub').innerText = subMsg || '';
        confirmCallback = cb;
        
        const btn = document.getElementById('confirm-yes-btn');
        const icon = document.getElementById('confirm-icon');
        
        if(type === 'danger') {
            btn.style.background = 'var(--danger)'; btn.style.color = '#fff';
            icon.innerText = 'ğŸ—‘ï¸';
        } else if(type === 'pick') {
            btn.style.background = 'var(--pick)'; btn.style.color = '#000';
            icon.innerText = 'ğŸ“¤';
        } else {
            btn.style.background = 'var(--accent)'; btn.style.color = '#000';
            icon.innerText = 'ğŸ¤”';
        }
        
        document.getElementById('confirm-modal').classList.add('open');
    }
    
    function closeConfirm() {
        document.getElementById('confirm-modal').classList.remove('open');
        confirmCallback = null;
    }
    
    document.getElementById('confirm-yes-btn').onclick = function() {
        if(confirmCallback) confirmCallback();
        closeConfirm();
    };


    function init() {
        try {
            let d = localStorage.getItem(KEY);
            if(!d) d = localStorage.getItem('components_v6_7_final'); 
            db = d ? JSON.parse(d) : (PRELOAD || []);
            
            let l = localStorage.getItem(LOG_KEY);
            logs = l ? JSON.parse(l) : [];
        } catch(e) { db=[]; logs=[]; }
        render();
        initTools();
        renderLogs();
        bindKeys();
    }
    
    function bindKeys() {
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
                e.preventDefault();
                document.getElementById('search-inp').focus();
            }
            if (e.key === 'Escape') {
                if (document.getElementById('modal-mask').classList.contains('open')) closeModal();
                else if (document.getElementById('batch-edit-modal').classList.contains('open')) closeBatchEdit();
                else if (document.getElementById('search-inp').value) clearSearch();
            }
        });
    }
    
    function save() {
        localStorage.setItem(KEY, JSON.stringify(db));
        render();
    }
    
    function saveLog(msg) {
        const entry = { t: Date.now(), m: msg };
        logs.unshift(entry);
        if(logs.length > 50) logs.pop(); // åªä¿ç•™50æ¡
        localStorage.setItem(LOG_KEY, JSON.stringify(logs));
        renderLogs();
    }
    
    function renderLogs() {
        const el = document.getElementById('log-list');
        if(logs.length === 0) { el.innerHTML = '<div style="padding:10px; text-align:center; opacity:0.5">æš‚æ— è®°å½•</div>'; return; }
        
        el.innerHTML = logs.map(l => {
            const date = new Date(l.t);
            const tStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
            return `<div class="log-item"><span class="log-time">${tStr}</span><span>${l.m}</span></div>`;
        }).join('');
    }
    
    function clearLogs() {
        showConfirm('æ¸…ç©ºæ‰€æœ‰æ—¥å¿—ï¼Ÿ', 'æ­¤æ“ä½œæ— æ³•æ’¤é”€', 'danger', () => {
            logs = [];
            localStorage.setItem(LOG_KEY, JSON.stringify(logs));
            renderLogs();
            toast('æ—¥å¿—å·²æ¸…ç©º');
        });
    }

    function switchTab(id, el) {
        document.querySelectorAll('.view-page').forEach(p=>p.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        el.classList.add('active');
        if(id === 'stats') renderChart();
        if(id === 'home') render();
    }

    function toggleSort() {
        if(sortMode === 'time') sortMode = 'qty';
        else if(sortMode === 'qty') sortMode = 'name';
        else sortMode = 'time';
        const btn = document.getElementById('sort-btn');
        const icon = document.getElementById('sort-icon');
        btn.classList.add('active');
        setTimeout(()=>btn.classList.remove('active'), 200);
        if(sortMode === 'time') icon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>';
        else if(sortMode === 'qty') icon.innerHTML = '<path d="M12 20V10"></path><path d="M18 20V4"></path><path d="M6 20v-4"></path>';
        else icon.innerHTML = '<path d="M15 12h-6"></path><path d="M15 8h-6"></path><path d="M19 18H5"></path>';
        toast(sortMode === 'time' ? 'æŒ‰æ—¶é—´æ’åº' : (sortMode === 'qty' ? 'æŒ‰æ•°é‡æ’åº' : 'æŒ‰åç§°æ’åº'));
        render();
    }

    function quickFilter(type) {
        const cTotal = document.getElementById('card-total');
        const cLow = document.getElementById('card-low');
        cTotal.classList.remove('active-filter');
        cLow.classList.remove('active-filter');
        if(type === 'Low') {
            if(activeFilter === 'Low') { activeFilter = 'All'; cTotal.classList.add('active-filter'); }
            else { activeFilter = 'Low'; cLow.classList.add('active-filter'); document.getElementById('filter-sel').value = 'All'; }
        } else {
            activeFilter = 'All'; cTotal.classList.add('active-filter'); document.getElementById('filter-sel').value = 'All';
        }
        render();
    }
    
    function searchTag(tag) {
        const inp = document.getElementById('search-inp');
        inp.value = '#' + tag + ' ';
        render();
        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        document.querySelector('.viewport').scrollTop = 0;
    }
    
    // --- æ ¸å¿ƒï¼šæ¸²æŸ“é€»è¾‘ ---
    function render() {
        document.getElementById('st-total').innerText = db.length;
        let low = db.filter(i=>i.qty<5).length;
        document.getElementById('st-low').innerText = low;
        document.getElementById('st-low').style.color = low>0 ? 'var(--danger)' : 'var(--text-sub)';

        const grid = document.getElementById('grid');
        const searchRaw = document.getElementById('search-inp').value.trim();
        let catFilter = document.getElementById('filter-sel').value;
        if(activeFilter === 'Low') catFilter = 'All';

        document.getElementById('search-clear').style.display = searchRaw ? 'flex' : 'none';

        // 1. æ‹†åˆ†å…³é”®å­— (ç©ºæ ¼åˆ†éš”)
        const safeSearch = searchRaw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
        const tokens = safeSearch.toLowerCase().split(/\s+/).filter(t => t.length > 0);
        
        let list = db.filter(i => {
            if(activeFilter === 'Low' && i.qty >= 5) return false;
            if(activeFilter !== 'Low' && catFilter !== 'All' && i.cat !== catFilter) return false;
            
            if(tokens.length === 0) return true;
            
            const text = (i.name + " " + (i.model||"") + " " + (i.loc||"") + " " + (i.desc||"")).toLowerCase();
            return tokens.every(token => text.includes(token));
        });

        list.sort((a, b) => {
            if(sortMode === 'qty') return a.qty - b.qty;
            if(sortMode === 'name') return a.name.localeCompare(b.name);
            return (b.time||0) - (a.time||0);
        });
        
        if(list.length===0) { 
            document.getElementById('empty-state').style.display='block'; 
            grid.innerHTML=''; 
            
            if(db.length === 0 && selectMode) exitSelection();
            else updateBatchBarState(); 
            return; 
        }
        document.getElementById('empty-state').style.display='none';
        
        const now = Date.now();
        const frag = document.createDocumentFragment();
        
        // æ„å»ºé«˜äº®æ­£åˆ™
        let hlPattern = null;
        if(tokens.length > 0) {
            const sortedTokens = [...tokens].sort((a,b) => b.length - a.length);
            hlPattern = new RegExp(`(${sortedTokens.join('|')})`, 'gi');
        }

        const hl = (txt) => {
            if(!txt) return '';
            if(!hlPattern) return txt;
            return txt.replace(hlPattern, '<span class="highlight">$1</span>');
        };
        
        list.forEach(i => {
            const el = document.createElement('div');
            const isSel = selected.has(i.id);
            const pickedQty = pickingMap[i.id] || 0;
            
            let classes = `card`;
            if(isSel) classes += ' selected';
            if(pickingMode && pickedQty > 0) classes += ' picked';
            el.className = classes;
            el.dataset.id = i.id; 
            
            let color = 'var(--success)';
            if(i.qty<=0) color='#64748b'; else if(i.qty<5) color='var(--danger)';
            let pct = Math.min(100, (i.qty/20)*100);
            const isRecent = i.time && (now - i.time < 86400000);
            
            el.onpointerdown = (e)=>onDown(e, i.id);
            el.onpointerup = (e)=>onUp(e, i.id);
            el.onpointermove = onMove;
            el.onpointercancel = onCancel;
            el.oncontextmenu = (e)=>{ e.preventDefault(); return false; };
            
            let linkHtml = '';
            if(i.link && i.link.startsWith('http')) {
                linkHtml = `<a href="${i.link}" target="_blank" class="link-icon" onpointerdown="event.stopPropagation()" onclick="event.stopPropagation()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></a>`;
            }

            // å¤„ç†æ ‡ç­¾: åŒ¹é… #åè·Ÿå­—ç¬¦
            let descHtml = hl(i.desc||'');
            // å°†æè¿°ä¸­çš„ #tag æ›¿æ¢ä¸ºå¯ç‚¹å‡»çš„ spanï¼Œæ³¨æ„é¿å…ç ´åå·²æœ‰çš„ highlight æ ‡ç­¾
            // è¿™é‡Œç®€å•å¤„ç†ï¼šå…ˆæ¸²æŸ“æè¿°æ–‡æœ¬ï¼Œå†æ›¿æ¢ tagã€‚ä¸ºäº†é¿å…åµŒå¥—htmlï¼Œæˆ‘ä»¬å‡è®¾tagä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦
            // æ›´å®‰å…¨çš„åšæ³•æ˜¯ï¼šåŸå§‹desc -> è¯†åˆ«tag -> ç”Ÿæˆhtml -> é«˜äº®å…³é”®è¯ã€‚è¿™é‡Œé‡‡ç”¨ç®€å•æ­£åˆ™ã€‚
            descHtml = descHtml.replace(/#([\w\u4e00-\u9fa5]+)/g, '<span class="tag-pill" onclick="searchTag(\'$1\'); event.stopPropagation();">#$1</span>');

            let qtyDisplay = '';
            if (pickingMode) {
                 qtyDisplay = `
                    <div class="qty-box" onpointerdown="event.stopPropagation()" onpointerup="event.stopPropagation()" onclick="event.stopPropagation()">
                        <button class="qty-btn" onclick="modPick(${i.id},-1)">-</button>
                        <div class="qty-val picked-val">${pickedQty}</div>
                        <button class="qty-btn" onclick="modPick(${i.id},1)">+</button>
                    </div>
                    <div style="font-size:10px; color:var(--text-sub); margin-left:6px;">åº“å­˜: ${i.qty}</div>
                 `;
            } else {
                qtyDisplay = `
                    <div class="qty-box" onpointerdown="event.stopPropagation()" onpointerup="event.stopPropagation()" onclick="event.stopPropagation()">
                        <button class="qty-btn" onclick="modQty(${i.id},-1)">-</button>
                        <div class="qty-val" style="color:${color}">${i.qty}</div>
                        <button class="qty-btn" onclick="modQty(${i.id},1)">+</button>
                    </div>
                `;
            }

            el.innerHTML = `
                ${linkHtml}
                <div class="check-mark"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
                <div class="card-meta">
                    <div class="tag-row">
                        <div class="recent-dot" style="display:${isRecent?'block':'none'}"></div>
                        <span class="tag">${i.cat}</span>
                    </div>
                    <span class="loc" onpointerdown="event.stopPropagation()" onpointerup="event.stopPropagation()" onclick="event.stopPropagation();copy('${i.loc}')">${hl(i.loc||'-')}</span>
                </div>
                <div class="card-title">${hl(i.name)}</div>
                ${i.model?`<span class="pkg">${hl(i.model)}</span>`:''}
                <div class="stock-bg"><div class="stock-fill" style="width:${pct}%; background:${color}"></div></div>
                <div class="card-footer">
                    <div class="desc-text">${descHtml}</div>
                    <div style="display:flex; align-items:center;">${qtyDisplay}</div>
                </div>
            `;
            frag.appendChild(el);
        });
        grid.innerHTML = '';
        grid.appendChild(frag);
        
        updateBatchBarState();
    }
    
    function updateBatchBarState() {
        const bar = document.getElementById('batch-bar');
        const tabs = document.getElementById('tab-bar');
        const pickBtn = document.getElementById('btn-pick-mode');
        const pickBadge = document.getElementById('pick-badge-main');
        
        const pickKeys = Object.keys(pickingMap).filter(k=>pickingMap[k]>0);
        pickBadge.style.display = pickKeys.length > 0 ? 'flex' : 'none';
        pickBadge.innerText = pickKeys.length;

        const addBtn = document.getElementById('btn-add-main');

        if(pickingMode) {
            document.getElementById('app-container').classList.add('picking-mode');
            addBtn.style.opacity = '0.5';
            addBtn.onclick = () => toast('é¢†æ–™æ¨¡å¼ä¸‹æ— æ³•æ·»åŠ ï¼Œè¯·å…ˆé€€å‡º'); 
            
            bar.classList.add('show');
            bar.classList.add('picking');
            tabs.style.transform = 'translateY(100%)'; 
            pickBtn.classList.add('active-mode');

            document.getElementById('batch-content-default').style.display = 'none';
            document.getElementById('batch-content-picking').style.display = 'flex';
            
            let totalPicked = 0;
            let typesPicked = 0;
            for(let k in pickingMap) {
                if(pickingMap[k] > 0) {
                    totalPicked += pickingMap[k];
                    typesPicked++;
                }
            }
            document.getElementById('pick-total').innerText = totalPicked;
            document.getElementById('pick-types').innerText = typesPicked;

        } else if(selectMode) {
            document.getElementById('app-container').classList.remove('picking-mode');
            addBtn.style.opacity = '1';
            addBtn.onclick = () => openModal();

            bar.classList.add('show');
            bar.classList.remove('picking');
            tabs.style.transform = 'translateY(100%)'; 
            pickBtn.classList.remove('active-mode');

            document.getElementById('batch-content-default').style.display = 'flex';
            document.getElementById('batch-content-picking').style.display = 'none';
            
            document.getElementById('sel-count').innerText = selected.size;
            const totalVisible = document.querySelectorAll('.card').length;
            const isAll = totalVisible > 0 && selected.size === totalVisible;
            document.getElementById('btn-select-all').innerText = isAll ? 'å…¨ä¸é€‰' : 'å…¨é€‰';
        } else {
            document.getElementById('app-container').classList.remove('picking-mode');
            addBtn.style.opacity = '1';
            addBtn.onclick = () => openModal();
            
            pickBtn.classList.remove('active-mode');
            bar.classList.remove('show');
            tabs.style.transform = 'translateY(0)';
        }
    }

    // --- é¢†æ–™æ¨¡å¼é€»è¾‘ ---
    function togglePickingMode() {
        if(selectMode) exitSelection();
        pickingMode = !pickingMode;
        if(pickingMode) toast('è¿›å…¥é¢†æ–™æ¨¡å¼: ç‚¹å‡» +/- å»ºç«‹æ¸…å•');
        else toast('é€€å‡ºé¢†æ–™æ¨¡å¼');
        render();
    }
    
    function modPick(id, d) {
        if(navigator.vibrate) navigator.vibrate(10);
        const item = db.find(x=>x.id==id);
        if(!item) return;
        
        let current = pickingMap[id] || 0;
        let next = Math.max(0, current + d);
        
        if(next > item.qty) {
            toast('åº“å­˜ä¸è¶³');
            return;
        }
        
        pickingMap[id] = next;
        if(pickingMap[id] === 0) delete pickingMap[id];
        
        const el = document.querySelector(`.card[data-id="${id}"] .picked-val`);
        if(el) el.innerText = next;
        const card = document.querySelector(`.card[data-id="${id}"]`);
        if(card) {
            if(next > 0) card.classList.add('picked');
            else card.classList.remove('picked');
        }
        
        updateBatchBarState();
    }
    
    function finishPicking(action) {
        const ids = Object.keys(pickingMap);
        if(ids.length === 0) { toast('æ¸…å•ä¸ºç©º'); return; }
        
        if(action === 'deduct') {
            showConfirm('ç¡®å®šæ‰£å‡åº“å­˜ï¼Ÿ', `å…± ${ids.length} ç§å…ƒä»¶å°†æ›´æ–°åº“å­˜`, 'pick', () => {
                let logMsg = "æ‰¹é‡å‡ºåº“: ";
                ids.forEach(id => {
                    let item = db.find(x => String(x.id) === String(id));
                    let qty = pickingMap[id];
                    if(item) {
                        item.qty = Math.max(0, item.qty - qty);
                        item.time = Date.now();
                        logMsg += `${item.name}-${qty}; `;
                    }
                });
                save();
                saveLog(logMsg);
                pickingMap = {}; 
                togglePickingMode();
                toast('å‡ºåº“å®Œæˆ âœ…');
            });
        } else if (action === 'export') {
            let text = "ğŸ“‹ é¢†æ–™æ¸…å•:\n";
            ids.forEach(id => {
                let item = db.find(x => String(x.id) === String(id));
                let qty = pickingMap[id];
                if(item) text += `- ${item.name} [${item.model}] x ${qty} (ä½:${item.loc})\n`;
            });
            copy(text);
        }
    }

    // --- æ™®é€šæ¨¡å¼é€»è¾‘ ---
    function modQty(id, d) {
        if(navigator.vibrate) navigator.vibrate(10);
        let i = db.find(x=>x.id==id);
        if(i) { 
            const oldQ = i.qty;
            i.qty = Math.max(0, parseInt(i.qty)+d); 
            i.time = Date.now(); 
            save(); 
        }
    }

    function onDown(e, id) {
        if(pickingMode) return; 
        
        touchStart = {x:e.clientX, y:e.clientY};
        isDrag = false; hasLongPressed = false; 
        const card = e.currentTarget;
        card.classList.add('pressing'); 
        if(!selectMode) {
            longPressTimer = setTimeout(()=>{
                if(!isDrag) {
                    hasLongPressed = true; card.classList.remove('pressing');
                    if(navigator.vibrate) navigator.vibrate(50);
                    selectMode = true; selected.add(id); card.classList.add('selected');
                    updateBatchBarState();
                }
            }, 500);
        }
    }

    function onMove(e) {
        if(Math.abs(e.clientX-touchStart.x)>15 || Math.abs(e.clientY-touchStart.y)>15) {
            isDrag = true; clearTimeout(longPressTimer); e.currentTarget.classList.remove('pressing');
        }
    }
    
    function onCancel(e) { isDrag = true; clearTimeout(longPressTimer); e.currentTarget.classList.remove('pressing'); }

    function onUp(e, id) {
        clearTimeout(longPressTimer); e.currentTarget.classList.remove('pressing');
        if(isDrag) return;
        if(pickingMode) return; 
        if(selectMode) { if(!hasLongPressed) toggleSelect(id); } else { if(!hasLongPressed) openModal(id); }
        hasLongPressed = false;
    }
    
    function toggleSelect(id) { 
        if(selected.has(id)) selected.delete(id); else selected.add(id); 
        if(selected.size==0) exitSelection(); else render(); 
    }
    
    function exitSelection() { selectMode=false; selected.clear(); render(); }
    
    function toggleSelectAll() {
        const gridItems = document.querySelectorAll('.card');
        const visibleIds = Array.from(gridItems).map(el => parseFloat(el.dataset.id));
        if(selected.size === visibleIds.length) selected.clear();
        else visibleIds.forEach(id => selected.add(id));
        render();
    }

    // --- æ‰¹é‡æ“ä½œé€»è¾‘ ---
    function openBatchEditModal() {
        if(selected.size === 0) return;
        document.getElementById('batch-edit-count').innerText = selected.size;
        document.getElementById('be-loc').value = '';
        document.getElementById('be-cat').value = '';
        document.getElementById('batch-edit-modal').classList.add('open');
    }
    
    function closeBatchEdit() {
        document.getElementById('batch-edit-modal').classList.remove('open');
    }
    
    function saveBatchEdit() {
        const newLoc = document.getElementById('be-loc').value.trim();
        const newCat = document.getElementById('be-cat').value;
        
        if(!newLoc && !newCat) { closeBatchEdit(); return; }
        
        let count = 0;
        db.forEach(item => {
            if(selected.has(item.id)) {
                if(newLoc) item.loc = newLoc;
                if(newCat) item.cat = newCat;
                item.time = Date.now();
                count++;
            }
        });
        
        save();
        saveLog(`æ‰¹é‡ä¿®æ”¹ ${count} é¡¹`);
        closeBatchEdit();
        exitSelection();
        toast('ä¿®æ”¹æˆåŠŸ âœ…');
    }

    function batchCopy() {
        if(selected.size === 0) return;
        let count = 0; let newItems = [];
        db.forEach(item => {
            if(selected.has(item.id)) {
                let copy = JSON.parse(JSON.stringify(item));
                copy.id = Date.now() + Math.random(); 
                copy.name = copy.name + " (å‰¯æœ¬)"; copy.name = copy.name.replace(" (å‰¯æœ¬) (å‰¯æœ¬)", " (å‰¯æœ¬)");
                copy.time = Date.now();
                newItems.push(copy); count++;
            }
        });
        db = [...db, ...newItems]; save(); exitSelection(); toast(`å·²å¤åˆ¶ ${count} ä¸ªå…ƒä»¶`);
        saveLog(`æ‰¹é‡å¤åˆ¶ ${count} é¡¹`);
    }

    function batchDel() {
        if(selected.size === 0) return;
        deletedBuffer = db.filter(i => selected.has(i.id));
        const count = deletedBuffer.length;
        
        showConfirm('ç¡®å®šåˆ é™¤ï¼Ÿ', `é€‰ä¸­äº† ${count} ä¸ªé¡¹ç›®`, 'danger', () => {
             db = db.filter(i=>!selected.has(i.id)); 
             exitSelection(); save(); 
             toast(`å·²åˆ é™¤ ${count} é¡¹`, true); 
             saveLog(`æ‰¹é‡åˆ é™¤ ${count} é¡¹`);
        });
    }

    function delItem() { 
        const id = document.getElementById('e-id').value;
        const item = db.find(x=>x.id == id); 
        if(item) {
            showConfirm('ç¡®å®šåˆ é™¤æ­¤å…ƒä»¶ï¼Ÿ', 'æ­¤æ“ä½œæ— æ³•æ’¤é”€', 'danger', () => {
                deletedBuffer = [item];
                db = db.filter(x=>x.id != id); 
                save(); closeModal(); 
                toast('å·²åˆ é™¤', true);
                saveLog(`åˆ é™¤: ${item.name}`);
            });
        }
    }

    function undoDelete() {
        if(!deletedBuffer || deletedBuffer.length === 0) return;
        db = [...db, ...deletedBuffer];
        deletedBuffer = null;
        save();
        toast('å·²æ’¤é”€ âœ…');
        saveLog('æ’¤é”€åˆ é™¤æ“ä½œ');
    }

    // --- å›¾è¡¨ ---
    function renderChart() {
        const svg = document.getElementById('donut-chart');
        const lgd = document.getElementById('legend-container');
        const t = db.length;
        document.getElementById('chart-total').innerText = t;
        if(t===0) return;
        let c = {}; db.forEach(i=>c[i.cat]=(c[i.cat]||0)+1);
        let colors = {'MCU':'#38bdf8','Sensor':'#8b5cf6','Passive':'#94a3b8','Module':'#10b981','Conn':'#f59e0b','Power':'#ef4444','Other':'#64748b'};
        let acc=0, svgH='', lgdH='';
        Object.keys(c).forEach(k => {
            let p = (c[k]/t)*100;
            let col = colors[k] || '#fff';
            svgH += `<circle class="chart-segment" cx="50" cy="50" r="15.9" fill="transparent" stroke="${col}" stroke-width="5" stroke-dasharray="${p} ${100-p}" stroke-dashoffset="-${acc}"></circle>`;
            acc += p;
            lgdH += `<div class="legend-item"><div class="legend-dot" style="background:${col}"></div><div>${k} (${c[k]})</div></div>`;
        });
        svg.innerHTML = svgH;
        lgd.innerHTML = lgdH;
        renderLogs(); 
    }

    // --- å·¥å…· ---
    const pkgMap = {'0402':'1.0x0.5','0603':'1.6x0.8','0805':'2.0x1.25','1206':'3.2x1.6','SOT23':'2.9x1.3','SOP8':'4.9x3.9'};
    function calcPkg() {
        let v = document.getElementById('pkg-inp').value.toUpperCase().replace(/\s/g,'');
        let r = pkgMap[v];
        if(r) {
            document.getElementById('pkg-res').innerText = r+' mm';
            let [w,h] = r.split('x');
            let vis = document.getElementById('pkg-visual');
            vis.style.width = (w*10)+'px'; vis.style.height = (h*10)+'px'; vis.style.background = 'var(--accent)'; vis.innerText='';
        } else {
            document.getElementById('pkg-res').innerText = '';
            document.getElementById('pkg-visual').style.width='60px'; document.getElementById('pkg-visual').style.height='60px'; document.getElementById('pkg-visual').style.background='none'; document.getElementById('pkg-visual').innerText='?';
        }
    }
    
    const rColors = ['black','brown','red','orange','yellow','green','blue','violet','grey','white','gold','silver'];
    const rVals = {black:0,brown:1,red:2,orange:3,yellow:4,green:5,blue:6,violet:7,grey:8,white:9};
    const rMuls = {black:1,brown:10,red:100,orange:1000,yellow:10000,green:100000,blue:1000000,gold:0.1,silver:0.01};
    let is5Band = false; let bands = [1, 0, 2, 10]; let activeBand = 0;
    
    function initTools() { renderResistorUI(); }
    function toggleBands() { is5Band=!is5Band; bands = is5Band?[1,0,0,2,10]:[1,0,2,10]; activeBand=0; document.getElementById('band-btn').innerText=is5Band?'5ç¯':'4ç¯'; renderResistorUI(); }
    function renderResistorUI() {
        const body = document.getElementById('res-body'); body.innerHTML = '';
        bands.forEach((bIdx, i) => {
            let d = document.createElement('div'); d.className = 'res-band'; d.style.backgroundColor = rColors[bIdx];
            if(i===activeBand) { d.style.boxShadow = '0 0 10px white'; d.style.transform = 'scale(1.2)'; }
            d.onclick = () => { activeBand=i; renderResistorUI(); };
            body.appendChild(d);
        });
        const pal = document.getElementById('color-palette'); pal.innerHTML = '';
        [0,1,2,3,4,5,6,7,8,9,10,11].forEach(ci => {
            let c = document.createElement('div'); c.className='c-dot'; c.style.backgroundColor = rColors[ci];
            c.onclick = () => { bands[activeBand]=ci; renderResistorUI(); }; pal.appendChild(c);
        });
        calcOhms();
    }
    function calcOhms() {
        let val = 0; let mIdx = is5Band ? bands[3] : bands[2]; let mul = rMuls[rColors[mIdx]] || 0;
        if(is5Band) val = (rVals[rColors[bands[0]]]*100 + rVals[rColors[bands[1]]]*10 + rVals[rColors[bands[2]]]) * mul;
        else val = (rVals[rColors[bands[0]]]*10 + rVals[rColors[bands[1]]]) * mul;
        let s = val + ' Î©';
        if(val>=1000) s = (val/1000) + ' kÎ©';
        if(val>=1000000) s = (val/1000000) + ' MÎ©';
        document.getElementById('res-val').innerText = s;
    }

    // --- å¼¹çª—/å¯¼å‡º ---
    function openExport() { document.getElementById('sheet-mask').classList.add('open'); }
    function closeExport() { document.getElementById('sheet-mask').classList.remove('open'); }
    function openModal(id) {
        if(pickingMode) return; // é¢†æ–™æ¨¡å¼ä¸æ‰“å¼€ç¼–è¾‘
        document.getElementById('modal-mask').classList.add('open');
        if(id) {
            let i = db.find(x=>x.id==id);
            document.getElementById('e-id').value=id; 
            document.getElementById('e-name').value=i.name; 
            document.getElementById('e-model').value=i.model; 
            document.getElementById('e-loc').value=i.loc; 
            document.getElementById('e-cat').value=i.cat; 
            document.getElementById('e-qty').value=i.qty; 
            document.getElementById('e-desc').value=i.desc||'';
            document.getElementById('e-link').value=i.link||''; 
            document.getElementById('btn-del').style.display='block';
        } else {
            document.getElementById('e-id').value=''; 
            document.getElementById('e-name').value=''; 
            document.getElementById('e-model').value=''; 
            document.getElementById('e-loc').value=''; 
            document.getElementById('e-qty').value=1; 
            document.getElementById('e-desc').value='';
            document.getElementById('e-link').value='';
            document.getElementById('btn-del').style.display='none';
        }
    }
    function closeModal() { document.getElementById('modal-mask').classList.remove('open'); }
    
    // --- æ‰‹åŠ¨æ·»åŠ /ç¼–è¾‘é€»è¾‘ ---
    function saveItem() {
        let id = document.getElementById('e-id').value;
        const name = document.getElementById('e-name').value.trim();
        const model = document.getElementById('e-model').value.trim();
        const loc = document.getElementById('e-loc').value.trim();
        const cat = document.getElementById('e-cat').value;
        const desc = document.getElementById('e-desc').value.trim();
        const link = document.getElementById('e-link').value.trim();
        const qty = parseInt(document.getElementById('e-qty').value)||0;

        // ä¿®å¤ï¼šä½¿ç”¨ toast æ›¿ä»£ alertï¼Œé¿å…è¢«æµè§ˆå™¨æ‹¦æˆª
        if(!name) { toast('âš ï¸ è¯·è¾“å…¥åç§°'); return; }

        // åˆå¹¶é€»è¾‘
        if (!id) {
            let duplicateIndex = db.findIndex(x => 
                x.name === name && 
                x.model === model && 
                x.loc === loc && 
                x.cat === cat && 
                x.desc === desc && 
                x.link === link
            );

            if (duplicateIndex > -1) {
                let oldQty = parseInt(db[duplicateIndex].qty) || 0;
                let addedQty = qty;
                db[duplicateIndex].qty = oldQty + addedQty;
                db[duplicateIndex].time = Date.now(); 
                save(); closeModal();
                saveLog(`åˆå¹¶å…ƒä»¶: ${name} +${addedQty}`);
                if(activeFilter === 'Low') quickFilter('All');
                if(sortMode === 'time') render();
                toast(`æ£€æµ‹åˆ°ç›¸åŒå…ƒä»¶ï¼Œæ•°é‡å·²åˆå¹¶: +${addedQty} âœ…`);
                return;
            }
        }

        let item = {
            id: id ? parseFloat(id) : Date.now(),
            name: name,
            model: model,
            loc: loc,
            cat: cat,
            qty: qty,
            desc: desc,
            link: link,
            time: Date.now()
        };
        if(id) { 
            let idx=db.findIndex(x=>x.id==id); 
            if(idx>-1) db[idx]=item; 
            saveLog(`ç¼–è¾‘: ${name}`);
        } else {
            db.push(item);
            saveLog(`æ–°å¢: ${name}`);
        }
        
        save(); closeModal();
        if(activeFilter === 'Low') quickFilter('All');
        if(sortMode === 'time') render();
        if(!id) toast('æ·»åŠ æˆåŠŸ');
    }
    
    function doExport(type) {
        closeExport();
        const date = new Date().toISOString().slice(0,10).replace(/-/g,'');
        const str = JSON.stringify(db, null, 2);
        
        if(type==='shopping') {
            const list = db.filter(i=>i.qty < 5);
            if(list.length === 0) { toast('æ²¡æœ‰ç¼ºè´§å…ƒä»¶'); return; }
            let text = "ğŸ›’ é‡‡è´­æ¸…å• (" + date + "):\n";
            list.forEach(i => {
                text += `- ${i.name} [${i.model||'æ— å°è£…'}] (åº“å­˜: ${i.qty})\n`;
            });
            copy(text);
        } else if(type==='copy') {
            copy(str);
        } else if(type==='download') {
            downloadFile(str, `å…ƒä»¶åº“_${date}.json`, 'application/json');
        } else if(type==='app') {
            let html = document.documentElement.outerHTML;
            // å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ­£åˆ™æ›¿æ¢ PRELOADï¼Œç¡®ä¿æ•°æ®æ³¨å…¥æˆåŠŸ
            const replacePattern = /const PRELOAD = \[[\s\S]*?\];/;
            if(replacePattern.test(html)) {
                html = html.replace(replacePattern, `const PRELOAD = ${str};`);
                downloadFile(html, `å…ƒä»¶åº“App_${date}.html`, 'text/html');
            } else {
                toast('âš ï¸ ç”Ÿæˆå¤±è´¥: æ— æ³•å®šä½æ•°æ®åŒº');
            }
        }
    }

    function downloadFile(content, name, mime) {
        try {
            const b = new Blob([content], {type:mime});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href=u; a.download=name; document.body.appendChild(a); a.click();
            setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(u); },1000);
            toast('å·²å¼€å§‹ä¸‹è½½', false);
        } catch(e) {
            console.error(e);
            toast('âŒ ä¸‹è½½è¢«æµè§ˆå™¨æ‹¦æˆªï¼Œè¯·å°è¯•[å¤åˆ¶æ•°æ®]', false);
        }
    }
    
    function triggerImport() { document.getElementById('file-input').click(); }
    
    // --- CSV BOM å¯¼å…¥é€»è¾‘ ---
    function onFileRead(e) {
        const f = e.target.files[0];
        if(!f) return;
        
        const fileName = f.name.toLowerCase();
        const reader = new FileReader();

        reader.onload = (evt) => {
            const content = evt.target.result;
            try {
                if (fileName.endsWith('.json')) {
                    // JSON å¯¼å…¥é€»è¾‘
                    const d = JSON.parse(content);
                    if(Array.isArray(d)) {
                        d.forEach(n=>{ let idx=db.findIndex(o=>o.id==n.id); if(idx>-1) db[idx]=n; else db.push(n); });
                        save(); toast('JSON å¯¼å…¥æˆåŠŸ');
                        saveLog(`å¯¼å…¥ JSON: ${d.length} é¡¹`);
                    } else alert('JSON æ ¼å¼é”™è¯¯');
                } else if (fileName.endsWith('.csv')) {
                    // CSV å¯¼å…¥é€»è¾‘
                    parseAndImportCSV(content);
                } else {
                    alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä½¿ç”¨ .json æˆ– .csv');
                }
            } catch(e) {
                console.error(e);
                alert('è¯»å–æ–‡ä»¶å¤±è´¥: ' + e.message);
            }
            e.target.value = '';
        };
        
        reader.readAsText(f);
    }

    function parseAndImportCSV(csvText) {
        const lines = csvText.split(/\r\n|\n/);
        if (lines.length < 2) { alert('CSV å†…å®¹ä¸ºç©º'); return; }

        // è§£æè¡¨å¤´ï¼Œæ‰¾åˆ°å„åˆ—çš„ç´¢å¼•
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
        
        // æ˜ å°„æ ‡å‡†åˆ—å (å˜‰ç«‹åˆ›/LCSC BOM)
        const map = {
            name: headers.indexOf('name'),
            footprint: headers.findIndex(h => h.includes('footprint')),
            qty: headers.findIndex(h => h.includes('quantity') || h === 'qty'),
            supplierPart: headers.findIndex(h => h.includes('supplier part')), // LCSC Part #
            designator: headers.indexOf('designator'),
            manufacturer: headers.indexOf('manufacturer'),
        };

        if (map.name === -1) { alert('é”™è¯¯ï¼šæ— æ³•åœ¨ CSV ä¸­æ‰¾åˆ° Name åˆ—'); return; }

        let addedCount = 0;
        let mergedCount = 0;

        // ä»ç¬¬2è¡Œå¼€å§‹éå†
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // å¤„ç† CSV çš„å¼•å· (ç®€å•æ­£åˆ™åˆ†å‰²)
            const row = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.trim().replace(/^"|"$/g, ''));
            
            // æå–æ•°æ®
            const name = row[map.name] || 'Unknown';
            const model = map.footprint > -1 ? (row[map.footprint] || '') : '';
            const qtyStr = map.qty > -1 ? row[map.qty] : '1';
            const qty = parseInt(qtyStr) || 1;
            const lcscPart = map.supplierPart > -1 ? row[map.supplierPart] : '';
            const designator = map.designator > -1 ? row[map.designator] : '';
            const manufacturer = map.manufacturer > -1 ? row[map.manufacturer] : '';

            // æ„é€ å­—æ®µ
            let link = '';
            if (lcscPart && lcscPart.toUpperCase().startsWith('C')) {
                link = `https://item.szlcsc.com/product/detail/${lcscPart}.html`;
            }
            
            let desc = manufacturer;
            if (lcscPart) desc += ` (${lcscPart})`;
            
            // è‡ªåŠ¨æ¨æ–­åˆ†ç±»
            let cat = 'Other';
            if (designator) {
                const prefix = designator.charAt(0).toUpperCase();
                if (['R', 'C', 'L', 'D', 'B'].includes(prefix)) cat = 'Passive';
                else if (['U'].includes(prefix)) cat = 'MCU';
                else if (['J', 'P', 'H', 'C'].includes(prefix)) cat = 'Conn'; // Connector
                else if (['M'].includes(prefix)) cat = 'Module';
                else if (['Q', 'S'].includes(prefix)) cat = 'Power'; // Transistor/Switch
            }

            // --- æ™ºèƒ½å¯¼å…¥é€»è¾‘ ---
            let existingIdx = db.findIndex(item => item.name === name && item.model === model);

            if (existingIdx > -1) {
                db[existingIdx].qty = (parseInt(db[existingIdx].qty) || 0) + qty;
                db[existingIdx].time = Date.now(); 
                mergedCount++;
            } else {
                db.push({
                    id: Date.now() + Math.random(),
                    name: name,
                    model: model,
                    loc: 'å¾…å…¥åº“',
                    cat: cat,
                    qty: qty,
                    desc: desc,
                    link: link,
                    time: Date.now()
                });
                addedCount++;
            }
        }

        save();
        saveLog(`BOMå¯¼å…¥: æ–°${addedCount}, åˆ${mergedCount}`);
        if(addedCount > 0 || mergedCount > 0) {
            toast(`BOMå¯¼å…¥å®Œæˆ: æ–°å¢ ${addedCount}, åˆå¹¶ ${mergedCount} âœ…`, true); 
        } else {
            toast('æœªå¯¼å…¥ä»»ä½•æ•°æ®');
        }
    }
    
    function copy(t) { 
        if(!t)return; 
        const a=document.createElement('textarea');
        a.value=t; document.body.appendChild(a); a.select(); 
        try { document.execCommand('copy'); toast('å·²å¤åˆ¶ âœ…'); } catch(e) { alert('å¤åˆ¶å¤±è´¥'); }
        document.body.removeChild(a); 
    }
    
    function clearSearch() { document.getElementById('search-inp').value=''; render(); }
    
    function toast(m, canUndo=false) { 
        const t = document.getElementById('toast'); 
        document.getElementById('toast-msg').innerText = m;
        document.getElementById('toast-undo').style.display = canUndo ? 'block' : 'none';
        t.classList.add('show'); 
        setTimeout(()=> {
            t.classList.remove('show'); 
        }, 3000); 
    }

    init();
</script>
</body>
</html>
